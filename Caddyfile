# Caddyfile for Coffee Agent - Local HTTPS Configuration
# https://caddyserver.com/docs/caddyfile

# Global options
{
	# Enable debug mode for local development (optional)
	# debug

	# Automatically use HTTPS with internal CA for local domains (enabled by default)
	# auto_https is enabled by default, no need to specify

	# Email for Let's Encrypt (optional, for production domains)
	# email your-email@example.com
}

# Main site configuration
# Use localhost for local development with automatic HTTPS
localhost, coffee-agent.local {
	# Reverse proxy to the coffee-agent container
	reverse_proxy coffee-agent:3000 {
		# Health check
		health_uri /api/health
		health_interval 30s
		health_timeout 10s

		# WebSocket support (important for Agora RTC)
		header_up Connection {>Connection}
		header_up Upgrade {>Upgrade}

		# Pass real client IP
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
	}

	# Security headers
	header {
		# Enable HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains"

		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"

		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"

		# XSS Protection
		X-XSS-Protection "1; mode=block"

		# Referrer Policy
		Referrer-Policy "strict-origin-when-cross-origin"

		# Remove Server header
		-Server
	}

	# Enable gzip compression
	encode gzip zstd

	# Logging
	log {
		output stdout
		format console
		level INFO
	}
}

# Optional: HTTP to HTTPS redirect (automatic with Caddy)
# http://localhost {
# 	redir https://localhost{uri} permanent
# }

# Optional: Additional domain for production
# yourdomain.com {
# 	reverse_proxy coffee-agent:3000
#
# 	# TLS configuration for production
# 	tls your-email@example.com
#
# 	# Same security headers and proxy config as above
# }
